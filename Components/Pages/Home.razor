@page "/"
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>Attack Dashboard</PageTitle>

<div class="dashboard-container">
    @if (_isLooping)
    {
        <div class="page-wrapper @(_fadeClass)">
            @switch (_currentPage)
            {
                case 0:
                    <AttackDashboard />
                    break;
                case 1:
                    <StockDashboard />
                    break;
                case 2:
                    <WeatherDashboard />
                    break;
            }
        </div>

        <div class="page-indicators">
            @for (int i = 0; i < _totalPages; i++)
            {
                var idx = i;
                <span class="page-dot @(idx == _currentPage ? "active" : "")"></span>
            }
        </div>
    }
    else
    {
        <AttackDashboard />
    }
</div>

@code {
    [SupplyParameterFromQuery(Name = "loop")]
    public string? Loop { get; set; }

    [SupplyParameterFromQuery(Name = "time")]
    public int Time { get; set; }

    private bool _isLooping;
    private int _currentPage = 0;
    private const int _totalPages = 3;
    private string _fadeClass = "fade-in";
    private System.Threading.Timer? _rotationTimer;
    private int _intervalSeconds = 120;

    protected override void OnInitialized()
    {
        _isLooping = Loop != null;
        if (Time > 0) _intervalSeconds = Time;

        if (_isLooping)
        {
            _rotationTimer = new System.Threading.Timer(async _ =>
            {
                try
                {
                    await InvokeAsync(async () =>
                    {
                        // Fade out
                        _fadeClass = "fade-out";
                        StateHasChanged();

                        await Task.Delay(400);

                        // Switch page
                        _currentPage = (_currentPage + 1) % _totalPages;
                        _fadeClass = "fade-in";
                        StateHasChanged();
                    });
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Rotation error: {ex.Message}");
                }
            }, null, TimeSpan.FromSeconds(_intervalSeconds), TimeSpan.FromSeconds(_intervalSeconds));
        }
    }

    public void Dispose()
    {
        _rotationTimer?.Dispose();
    }
}
